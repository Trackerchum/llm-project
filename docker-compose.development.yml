
# Dev setup note:
# node_modules are stored in Docker volumes (not the image) to avoid Windowsâ†”Linux pnpm/symlink issues and to support hot reload.
# Because volumes are empty at startup, `pnpm install` and mkdir must run at container runtime (not during image build).
# Prod images should bake dependencies instead.
services:
  frontend:
    image: ulp-frontend
    build:
      context: .
      dockerfile: src/frontend/main-ui/Dockerfile.development
      args:
        - REACT_APP_SERVICES_HOST=/api
    container_name: frontend-main-ui
    working_dir: /app/src/frontend/main-ui
    command: sh -c "pnpm install --frozen-lockfile && pnpm run start"
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      # Root workspace deps
      - root_node_modules:/app/node_modules
      # Workspace package deps
      - frontend_main-ui_node_modules:/app/src/frontend/main-ui/node_modules
      # pnpm store
      - pnpm_store:/pnpm-store
    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    networks:
      - frontend

  server:
    image: ulp-server
    build:
      context: .
      dockerfile: src/backend/server/Dockerfile.development
    container_name: backend-server
    working_dir: /app/src/backend/server
    command: sh -c "pnpm install --frozen-lockfile && mkdir -p build && touch build/server.js && pnpm run start"
    ports:
      - "5001:5001"
    volumes:
      - .:/app
      # Root workspace deps
      - root_node_modules:/app/node_modules
      # Workspace package deps
      - backend_server_node_modules:/app/src/backend/server/node_modules
      - shared_node_modules:/app/src/backend/shared/node_modules
      # pnpm store
      - pnpm_store:/pnpm-store
    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    depends_on:
      - db-redis
    networks:
      - server

  identity-server:
    image: ulp-identity-server
    build:
      context: .
      dockerfile: src/backend/identity-server/Dockerfile.development
    container_name: backend-identity-server
    working_dir: /app/src/backend/identity-server
    command: sh -c "pnpm install --frozen-lockfile && mkdir -p build && touch build/server.js && pnpm run start"
    ports:
      - "8001:8001"
    volumes:
      - .:/app
      # Root workspace deps
      - root_node_modules:/app/node_modules
      # Workspace package deps
      - backend_identity-server_node_modules:/app/src/backend/identity-server/node_modules
      - shared_node_modules:/app/src/backend/shared/node_modules
      # pnpm store
      - pnpm_store:/pnpm-store
    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    depends_on:
      - db-redis
    networks:
      - server

  db-redis:
    image: ulp-redis
    build:
      context: ./src/db/redis
      dockerfile: Dockerfile.development
    container_name: db-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - server

  redis-insight:
    image: redislabs/redisinsight:3.0
    # run as root user so container can write to volume
    user: "0:0"
    ports:
      - "6479:6479"
    volumes:
      - redisinsight_data:/data
    depends_on:
      - db-redis
    networks:
      - server

  proxy-nginx:
    image: ulp-proxy-nginx
    build:
      context: ./src/proxy/nginx
      dockerfile: Dockerfile.development
    ports:
      - "80:80"
    depends_on:
      - frontend
      - server
      - identity-server
    networks:
      - frontend
      - server

networks:
  frontend:
  server:


volumes:
  root_node_modules:
  frontend_main-ui_node_modules:
  backend_server_node_modules:
  backend_identity-server_node_modules:
  shared_node_modules:
  pnpm_store:
  redis_data:
  redisinsight_data:
