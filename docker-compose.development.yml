
services:
  frontend:
    image: ulp-frontend
    build:
      context: .
      dockerfile: src/frontend/main-ui/Dockerfile.development
      args:
        - REACT_APP_SERVICES_HOST=/api
    container_name: frontend-main-ui
    working_dir: /app/src/frontend/main-ui
    command: >
      sh -c "
        cd /app
        if [ ! -d node_modules ]; then
          npm ci
        fi
        cd /app/src/frontend/main-ui
        npm run start
      "
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - root_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    networks:
      - frontend

  server:
    image: ulp-server
    build:
      context: .
      dockerfile: src/backend/server/Dockerfile.development
    container_name: backend-server
    working_dir: /app/src/backend/server
    command: >
      sh -c "
        cd /app
        if [ ! -d node_modules ]; then
          npm ci
        fi
        cd /app/src/backend/server
        mkdir -p build
        touch build/server.js
        npm run start
      "
    ports:
      - "5001:5001"
    volumes:
      - .:/app
      - root_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    depends_on:
      - db-redis
    networks:
      - server

  identity-server:
    image: ulp-identity-server
    build:
      context: .
      dockerfile: src/backend/identity-server/Dockerfile.development
    container_name: backend-identity-server
    working_dir: /app/src/backend/identity-server
    command: >
      sh -c "
        cd /app
        if [ ! -d node_modules ]; then
          npm ci
        fi
        cd /app/src/backend/identity-server
        mkdir -p build
        touch build/server.js
        npm run start
      "
    ports:
      - "8001:8001"
    volumes:
      - .:/app
      - root_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    depends_on:
      - db-redis
    networks:
      - server

  db-redis:
    image: ulp-redis
    build:
      context: ./src/db/redis
      dockerfile: Dockerfile.development
    container_name: db-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - server

  redis-insight:
    image: redislabs/redisinsight:3.0
    # run as root user so container can write to volume
    user: "0:0"
    ports:
      - "6479:6479"
    volumes:
      - redisinsight_data:/data
    depends_on:
      - db-redis
    networks:
      - server

  proxy-nginx:
    image: ulp-proxy-nginx
    build:
      context: ./src/proxy/nginx
      dockerfile: Dockerfile.development
    ports:
      - "80:80"
    depends_on:
      - frontend
      - server
      - identity-server
    networks:
      - frontend
      - server

networks:
  frontend:
  server:


volumes:
  root_node_modules:
  redis_data:
  redisinsight_data:
